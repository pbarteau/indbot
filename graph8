from langgraph.graph import StateGraph, START, END

def interface_llm(state: State):
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system", "You are a customer care bot, tell me whether the given problem is a billing issue, technical issue or feedback."),
            ("user", "issue: {issue}"),
        ]
    )
    chain = prompt | llm
    user_msg = state["messages"][-1].content
    response = chain.invoke({"issue": user_msg}).content
    return {"messages": state["messages"] + [response]}

def router_decision(state: State):
    classification = state["messages"][-1].content.lower().strip()

    if "billing" in classification:
        return "billing_node"
    elif "technical" in classification:
        return "technical_node"
    elif "feedback" in classification:
        return "feedback_node"
    else:
        return "feedback_node"



def billing_llm(state: State):
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system", "You are a billing bot, help the customer with the billing issue."),
            ("user", "issue: {issue}"),
        ]
    )
    chain = prompt | llm
    user_msg = state["messages"][-2].content
    response = chain.invoke({"issue": user_msg}).content
    return {"messages": state["messages"] + [response]}


def technical_llm(state: State):
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system", "You are a technical support bot, help the customer with the techinical issue."),
            ("user", "issue: {issue}"),
        ]
    )
    chain = prompt | llm
    user_msg = state["messages"][-2].content
    response = chain.invoke({"issue": user_msg}).content
    return {"messages": state["messages"] + [response]}


def feedback_llm(state: State):
    prompt = ChatPromptTemplate.from_messages(
        [
            ("system", "You  are a feedback bot, thank the customer for their feedback."),
            ("user", "issue: {issue}"),
        ]
    )
    chain = prompt | llm
    user_msg = state["messages"][-2].content
    response = chain.invoke({"issue": user_msg}).content
    return {"messages": state["messages"] + [response]}


graph_builder = StateGraph(State)


#add nodes
graph_builder.add_node("interface_node", interface_llm)
graph_builder.add_node("billing_node", billing_llm)
graph_builder.add_node("technical_node", technical_llm)
graph_builder.add_node("feedback_node", feedback_llm)


#add edges
graph_builder.add_edge(START, "interface_node")
graph_builder.add_conditional_edges(
    "interface_node",
    router_decision,
    {
        "billing_node": "billing_node",
        "technical_node": "technical_node",
        "feedback_node": "feedback_node",
    }
)
graph_builder.add_edge("billing_node", END)
graph_builder.add_edge("technical_node", END)
graph_builder.add_edge("feedback_node", END)

graph = graph_builder.compile()
